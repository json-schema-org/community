name: Send reminders to join the OCWM the same day

on:
  schedule:
    - cron: '0 15 * * 1'  # Runs every Monday at 15:00

  repository_dispatch:
    types: ocwm-reminders

jobs:
  ocwm-reminders:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    - name: Set up Node 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Get Token 
      uses: actions/create-github-app-token@v1
      id: get_workflow_token
      with:
        app-id: ${{ vars.APP_ID }}
        private-key: ${{ secrets.PRIVATE_KEY }}

    - name: Install dependencies
      run: npm install @octokit/core@5.1.0

    # Step to check if today is the third Monday
    - name: Check if today is the third Monday
      id: check-third-monday
      run: |
        day=$(date +%d)
        dow=$(date +%u)  # Day of the week (1 = Monday, ..., 7 = Sunday)
        # Check if the day is between 15th and 21st, and if it's Monday (1)
        if [ "$dow" -ne 1 ]; then
          echo "Not a Monday, exiting..."
          echo "::set-output name=is-third-monday::false"
          exit 0
        fi
        if [ "$day" -ge 15 ] && [ "$day" -le 21 ]; then
          echo "This is the third Monday of the month!"
          echo "::set-output name=is-third-monday::true"
        else
          echo "Not the third Monday, exiting..."
          echo "::set-output name=is-third-monday::false"
          exit 0
        fi

    - name: Send reminders
      if: steps.check-third-monday.outputs.is-third-monday == 'true'
      uses: actions/github-script@v7
      env:
        MY_TOKEN: ${{ steps.get_workflow_token.outputs.token }}
        OWNER: ${{ vars.ORGANISATION }}
        REPO: 'community'
        OCWM_LABEL: ${{ vars.OCWM_LABEL }}
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_REMINDER }}
      with:
        script: |
        
          const octokit = require('@octokit/core').Octokit;
          const mygithub = new octokit({
            request: { fetch: fetch,},
            auth: process.env.MY_TOKEN
          });

          console.log("Starting Send reminders step");
          console.log("Token available:", process.env.MY_TOKEN ? "Yes (masked)" : "No");
          console.log("Slack webhook available:", process.env.SLACK_WEBHOOK ? "Yes (masked)" : "No");
          console.log("Owner:", process.env.OWNER);
          console.log("Repository:", process.env.REPO);
          console.log("OCWM Label:", process.env.OCWM_LABEL);

          let targetLabel = encodeURIComponent(process.env.OCWM_LABEL);

          console.log("Fetching working meetings from GitHub API...");
          const { data: workMeetings } = await mygithub.request(`GET /repos/${process.env.OWNER}/${process.env.REPO}/issues?labels=${targetLabel}&per_page=1`, {
          })

          console.log("Number of work meetings found:", workMeetings.length);
          
          if (workMeetings.length === 0) {
            console.error("No working meetings found with label:", process.env.OCWM_LABEL);
            throw new Error("No working meetings found");
          }

          const issueNumber = workMeetings[0].number;
          const newTitle = workMeetings[0].title;
          const issueUrl = workMeetings[0].html_url;
          const issueDate = newTitle.replace(/Open Community Working Meeting /g, "");
          
          console.log("Found issue number:", issueNumber);
          console.log("Issue title:", newTitle);
          console.log("Issue URL:", issueUrl);
          console.log("Extracted date from title:", issueDate);
          
          // Notify Slack
          const SLACK_WEBHOOK_URL = process.env.SLACK_WEBHOOK;
          const SLACK_MESSAGE = `{
            "issue": "https://github.com/${process.env.OWNER}/${process.env.REPO}/issues/${issueNumber}",
            "date": "${issueDate}"
          }`;

          console.log("Slack message payload:", SLACK_MESSAGE;

          console.log("Sending Slack reminder notification...");
          const slackResponse = await fetch(SLACK_WEBHOOK_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: SLACK_MESSAGE,
          });

          console.log("Slack response status:", slackResponse.status);
          console.log("Slack response status text:", slackResponse.statusText);
          
          if (!slackResponse.ok) {
            const errorText = await slackResponse.text();
            console.error("Slack reminder notification failed:", errorText);
            throw new Error(`Slack reminder notification failed: ${slackResponse.status} ${slackResponse.statusText}`);
          } else {
            const responseText = await slackResponse.text();
            console.log("Slack reminder notification sent successfully");
            console.log("Slack response:", responseText);
          }
